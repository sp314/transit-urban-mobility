---
title: "Impact of the 2016 Presidential Election on Urban Mobility: Who is Affected the Most?"
output:
  html_document:
    df_print: paged
    theme: cerulean
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(rgdal)
library(tigris)
library(spdep)
library(spatialreg)
library(ape)

#tigris package - contains roads for DC
options(tigris_class="sf")

load("data/travel_times_census_join.RData")
load("data/dc_acs_tracts.RData")
load("data/metro_lines.RData")
load("data/dc_roads.RData")
theme_map <- theme_void()
```

Data is taken from [here](https://movement.uber.com/?lang=en-US) from the "Travel Times" dataset for Boston. We want to look at how different transit policies impact the travel times within a city.

This research will first look at how travel times across Washington D.C. generally vary before and during the 2016 presidential election. We will then explore variations of this across different neighborhoods, income, and racial divides to examine bottlenecks in mobility for different identity groups. This research will contribute in explaining and interpreting variations in urban mobility during major events. It adds to the limited literature covering congestion capacity during agglomerating events such as the Olympics, natural disasters, and major holidays. It also aims to contribute by identifying heterogeneity across different socioeconomic barriers to better inform urban policy and planning aiming for equitable mobility.

## Introduction

* Explain traffic/congestion/mobility with statistics etc.
* Explain how these factors are magnified during a major event like the Olympics
* Tie in how different people may be affected (?)
* Start introducing the 2016 Election

According to the New York Times, crowd scientists estimated 470,000 people were at the women’s march in Washington on January 21st, 2017. They say that the crowd at the women’s march was about three times the size of the crowd at the Trump inauguration, making the crowd roughly 160,000 people at the Trump inauguration.
https://www.nytimes.com/interactive/2017/01/22/us/politics/womens-march-trump-crowd-estimates.html
The 2010 data set of demographic information by census tracts comes from Urban Institute: https://greaterdc.urban.org/data-explorer?geography=tr10&indicator=PctBlackNonHispBridge&topic=population&year=2012-16

```{r centroids}
dc_acs_tracts$centroids <- st_centroid(st_geometry(dc_acs_tracts), of_largest_polygon)

plot(st_geometry(dc_acs_tracts), border="grey")
plot(dc_acs_tracts$centroids, add=TRUE, col="blue", cex = 0.3)
```

```{r join_sf}
centroids <- data.frame(cbind(st_coordinates(st_centroid(dc_acs_tracts))))

centroids <- centroids %>%
  mutate(GEOID = dc_acs_tracts$GEOID)

dc_acs_tracts <- left_join(x = dc_acs_tracts, y = centroids, by = "GEOID")

travel_time_sf <- left_join(x = travel_times_census_join, y = dc_acs_tracts, by = "GEOID") %>%
	st_as_sf() %>%
	st_transform(crs = 102285)
```

```{r dist_to_center}
# Compute distance from Washington Monument
mnm <- tribble(
  ~latitude, ~longitude,
  38.8895, -77.0353
)

mnm_sf <- mnm %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  st_transform(crs = 102285)

travel_time_sf <- travel_time_sf %>%
  mutate(distance = st_distance(centroids, mnm_sf$geometry, by_element = TRUE),
  			 march_inaug = ifelse((year == 2017 & month == 1 & week %in% c(3, 4)), 1, 0))
```

```{r map_travel_time}
map_lims <- st_bbox(dc_acs_tracts)

travel_time_sf %>% filter(year == 2017, month == 1, week == 3) %>%
	ggplot() +
	geom_sf(mapping = aes(fill = mean_travel_time), lwd=0.2) +
	geom_sf(data = travel_time_sf$centroids, cex = 0.5) +
	scale_fill_viridis_c(direction = -1)

travel_time_sf %>% filter(year == 2017, month == 1, week == 4) %>%
	ggplot() +
	geom_sf(mapping = aes(fill = mean_travel_time), lwd=0.2) +
	geom_sf(data = dc_roads, color = "white", lwd=0.2) +
	geom_sf(data = metro_line, color = "black", lwd=0.2) +
	theme_map +
  coord_sf(xlim = c(map_lims["xmin"], map_lims["xmax"]), ylim = c(map_lims["ymin"], map_lims["ymax"])) +
	scale_fill_viridis_c(direction = -1)
```

```{r map_acs}
travel_time_sf %>% filter(year == 2017, month == 1, week == 3) %>%
	ggplot() +
	geom_sf(mapping = aes(fill = med_incomeE)) +
	theme_map +
	scale_fill_viridis_c()
```

```{r map_acs}
travel_time_sf %>% filter(year == 2017, month == 1, week == 3) %>%
	ggplot() +
	geom_sf(mapping = aes(fill = blackE)) +
	theme_map +
	scale_fill_viridis_c()

travel_time_sf %>% filter(year == 2017, month == 1, week == 3) %>%
	ggplot() +
	geom_sf(mapping = aes(fill = car_transitE)) +
	theme_map +
	scale_fill_viridis_c()
```

## Modeling

```{r}
travel_time_sf$NumRoads <- sapply(st_intersects(travel_time_sf,dc_roads),length)
travel_time_sf$NumMetro <- sapply(st_intersects(travel_time_sf,metro_line),length)

#Averaged travel times over weeks 1 and 2 in January
weeks12 <- travel_time_sf %>% 
  filter(year %in% 2017) %>% 
  filter(month %in% 1) %>% 
  filter(week %in% 1:2) %>%
  select(GEOID,mean_travel_time) %>%
  as.data.frame() %>%
  group_by(GEOID) %>%
  summarize(MeanTimeNorm = mean(mean_travel_time)) 

weeks34 <- travel_time_sf %>% 
  filter(year %in% 2017) %>% 
  filter(month %in% 1) %>% 
  filter(week %in% 3:4) %>%
  select(GEOID,mean_travel_time) %>%
  as.data.frame() %>%
  group_by(GEOID) %>%
  summarize(MeanTimeIng = mean(mean_travel_time)) 
  
mod1data <- travel_time_sf %>%
  dplyr::select(GEOID, starts_with('med_'),starts_with('white'),starts_with('asian'),starts_with('black'),starts_with('car_trans'),starts_with('public_trans'),NumRoads,NumMetro) %>%
  left_join(weeks12)

mod2data <- travel_time_sf %>%
  dplyr::select(GEOID, starts_with('med_'),starts_with('white'),starts_with('asian'),starts_with('black'),starts_with('car_trans'),starts_with('public_trans'),NumRoads,NumMetro) %>%
  left_join(weeks34)

weeksdiff = left_join(weeks12,weeks34) %>%
  mutate(diffMeanTime = MeanTimeIng-MeanTimeNorm)
 

mod3data <- travel_time_sf %>%
  dplyr::select(GEOID, starts_with('med_'),starts_with('white'),starts_with('asian'),starts_with('black'),starts_with('car_trans'),starts_with('public_trans'),NumRoads,NumMetro) %>%
  left_join(weeksdiff)
```

```{r}
st_queen <- function(a, b = a) st_relate(a, b, pattern = "F***T****")
as.nb.sgbp <- function(x, ...) {
  attrs <- attributes(x)
  x <- lapply(x, function(i) { if(length(i) == 0L) 0L else i } )
  attributes(x) <- attrs
  class(x) <- "nb"
  x
}

Queen <- as.nb.sgbp(st_queen(weeks34))
W <- nb2mat(Queen, style='B', zero.policy = TRUE)

plot(weeks34["mean_travel_time"])
plot(Queen, weekw34$centroids, col="blue", cex = 0.5, lwd = 0.5)
```

```{r CSR_test}
Moran.I(week_1$mean_travel_time, W, na.rm=TRUE)
```